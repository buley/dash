<html>
	<head>
		<title>InDB.js > examples > add_items.html</title>
		<script type='text/javascript' src='http://code.jquery.com/jquery-latest.js'></script> 
		<script src='../indb.dev.js' type='text/javascript'></script>
	</head>
	<body>
		<div id='results'>
			<ul id="counts">
				<li id="requests">Requested: <span class='count'>0</span></li>
				<li id="successes">Sucesses: <span class='count'>0</span></li>
				<li id="errors">Errors: <span class='count'>0</span></li>
			</ul>	
		</div>	

		<script type='text/javascript'>
			var warnLevel = 'log'; //also valid: alert (defaults to error object)
			InDB.assert( 'hello'==='world', 'inDB.js is loaded', warnLevel );
			
			/* Setup */
			var browser_check = InDB.checkBrowser();
			InDB.assert( -1 !== browser_check, 'incompatible browser' );
			if( 0 === browser_check ) {
				InDB.fixBrowser();
			}

			/* Constants */
			var database_name = 'InDB_examples_7';
			var database_desc = 'An IndexedDB to store InDB examples';

			var stores = {
				'todos': { 
					'key': 'id'
				}
			};
	
			var on_success = function( event ) {
				if( !!InDB.debug ) {
					console.log( 'success', event );
				}
			}
			var on_error = function( event ) {
				if( !!InDB.debug ) {
					console.log( 'error', event );
				}
			}		
			var on_abort = function( event ) {
				if( !!InDB.debug ) {
					console.log( 'abort', event );
				}
			}		
			var on_complete = function( event ) {
				if( !!InDB.debug ) {
					console.log( 'complete', event );
				}
			}		
	
			/* Load database or create and load if necessary */
			InDB.database.load( database_name, database_desc, on_success, on_error, on_abort );

			/* Listen for the event that shows the database is ready to work with */
			InDB.bind( 'InDB_database_loaded_success', function( event, context ) {
				if( !!InDB.debug ) {
					console.log( 'The IndexedDB database was loaded', event, context );
				}
			} );
		
			/* Create object stores after the database is created */
			InDB.bind( 'InDB_database_created_success', function( event, context ) {
				// Assert that the database is already loaded
				if( InDB.assert( InDB.db !== 'Object', 'Database not loaded' ) ) {
					if( !!InDB.debug ) {
						console.log( 'Database created', event, context );
					}
				}
				console.log( 'Adding object stores' );
				InDB.stores.create( stores, function( event ) {
					console.log( 'Object store created', event );
				}, function( event ) {

					if( !!InDB.debug ) {
						console.log( 'Object store creation error', event );
					}
				} );
			} );

			InDB.bind( 'InDB_object_store_created_success', function( event, context ) {
				if( !!InDB.debug ) {
					console.log( 'Object store created', event, context );
				}
			} );

			/* InDB_store_already_exists is a specific type of InDB_store_created_error */
			InDB.bind( 'InDB_store_already_exists', function( event, context ) {
				if( !!InDB.debug ) {
					console.log( 'Object store already exists', event, context );
				}
			} );

			InDB.bind( 'InDB_stores_loaded_success', function( event, context ) {

				if( !!InDB.debug ) {
					console.log( 'Object stores loaded', event, context );
				}

				//Is this the droid we're looking for?
				if( !InDB.isEmpty( event ) ) {

					var chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";
					var string_length = 4;
					var data = [];
					for( var k=0; k < 5; k++ ) {
						var randomstring = '';
						for (var i=0; i<string_length; i++) {
							var rnum = Math.floor(Math.random() * chars.length);
							randomstring += chars.substring(rnum,rnum+1);
						}
						data.push( {
							'text': randomstring
							, 'timeStamp': new Date().getTime()
						} );
                                        }

					var item_added_callback = function( event ) { 
						if( !!InDB.debug ) {
							console.log( 'Added to object store', event );
						}

					}

					for( var i = 0; i < data.length; i++ ) {
						var item = data[ i ];
						if( !!InDB.debug ) {
							console.log( "Adding data to object store", context.name, item );
						}
						for( store in stores ) {
							InDB.row.add( store, item, item_added_callback );
						}
					}
				}
			} );

			InDB.bind( 'InDB_example_get_items', function( event, context ) {
				if( !!InDB.debug ) {
					console.log( 'Getting items', event, context );
				}
				InDB.cursor.get( "todos", null, InDB.range.left_open( "a" ), function(e){console.log("got",e);} );
			} );

	
			/* UI listeners */

			InDB.bind( 'InDB_row_adding', function( event, context ) {
				console.log( 'An item is being added to an object store', event, context );
				var node = jQuery( '#requests > .count ');
				node.html( parseInt( node.html(), 10 ) + 1 );
			} );

			InDB.bind( 'InDB_row_added_success', function( event, context ) {
				console.log( 'An item was added to an object store', event, context );
				var node = jQuery( '#successes > .count ');
				node.html( parseInt( node.html(), 10 ) + 1 );
			} );

			InDB.bind( 'InDB_row_added_error', function( event, context ) {
				console.log( 'There was an error adding something to an object store', event, context );
				var node = jQuery( '#error > .count');
				node.html( parseInt( node.html(), 10 ) + 1 );
		} );


		</script>
	</body>
</html>
